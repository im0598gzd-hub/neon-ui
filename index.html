<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minimal Web UI (vA6) â€” READ/WRITE/RESTORE</title>
  <style>
    :root{--bg:#0d1117;--fg:#e6edf3;--muted:#8b949e;--line:#30363d;--card:#161b22;--blue:#58a6ff;--green:#2ea043;--red:#f85149}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:0 0 6px;color:#79c0ff}
    .sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,textarea{width:100%;background:#0f1420;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:10px 12px}
    textarea{resize:vertical}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button{background:#0f1420;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--green);border-color:var(--green);color:#fff}
    button.danger{border-color:var(--red);color:var(--red)}
    button.ghost{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
    .code{background:#0b1020;border:1px solid var(--line);border-radius:10px;padding:12px;overflow:auto;max-height:260px}
    .pwline{display:flex;gap:6px}
    /* â† è¿½åŠ ï¼šå‰Šé™¤æ¸ˆã¿è¡Œã®ç°è‰²åŒ– */
    .deleted-row{opacity:.55;background:#20252e}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Minimal Web UI (vA6)</h1>
    <p class="sub">ã€ŒäººãŒè§¦ã‚Œã¦ã‚‚å£Šã‚Œãªã„æœ€å°ã®çª“ã€â€” GitHub Pagesï¼ˆUIï¼‰ Ã— Renderï¼ˆAPIï¼‰</p>
  </header>

  <main class="wrap grid">
    <!-- éµã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="card">
      <h2>ğŸ” éµï¼ˆBearerï¼‰</h2>
      <p class="mono">â€» sessionStorage ã®ã¿ä¿å­˜<br>â€» ç”»é¢å…±æœ‰ãƒ»éŒ²ç”»æ™‚ã«éµã‚’<strong>è¡¨ç¤ºã—ãªã„</strong>ã§ãã ã•ã„ã€‚</p>

      <label for="readToken">READ ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="readToken" type="password" placeholder="READ ç”¨ Bearer å€¤">
        <button id="showRead" class="ghost">è¡¨ç¤º(3s)</button>
      </div>

      <label for="writeToken">WRITE/ADMIN ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="writeToken" type="password" placeholder="WRITE/ADMIN ç”¨ Bearer å€¤">
        <button id="showWrite" class="ghost">è¡¨ç¤º(3s)</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="saveTokens" class="primary">éµã‚’ä¿å­˜ï¼ˆã“ã®ã‚¿ãƒ–å†…ï¼‰</button>
        <button id="clearTokens" class="danger">éµã‚’ã™ã¹ã¦æ¶ˆå»</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h2>ğŸ©º /health</h2>
      <div class="row">
        <button id="btnHealth">/health ã‚’ç¢ºèª</button>
        <span id="healthStatus" class="mono"></span>
      </div>
      <pre id="healthRaw" class="code"></pre>
    </section>

    <!-- notes ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="card">
      <h2>ğŸ—’ï¸ /notesï¼ˆä¸€è¦§ãƒ»æŠ•ç¨¿ãƒ»å‰Šé™¤ãƒ»å¾©å…ƒï¼‰</h2>
      <div class="row">
        <button id="btnLoad">ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€ï¼ˆREADï¼‰</button>
        <label><input type="checkbox" id="showDeleted"> å‰Šé™¤æ¸ˆã¿ã‚‚è¡¨ç¤º</label>
        <span id="loadStatus" class="mono"></span>
      </div>
      <table class="table" id="notesTable">
        <thead><tr><th>ID</th><th>Content</th><th>Tags</th><th>Created</th><th>Updated</th><th>Deleted</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h3>âœï¸ æ–°è¦æŠ•ç¨¿</h3>
      <label for="content">content</label>
      <textarea id="content" rows="4" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
      <label for="tags">tagsï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
      <input id="tags" type="text" placeholder="ä¾‹: project,idea">
      <div class="row" style="margin-top:8px">
        <button id="btnPost" class="primary">æŠ•ç¨¿ã™ã‚‹ï¼ˆADMINï¼‰</button>
        <span id="postStatus" class="mono"></span>
      </div>
      <pre id="postRaw" class="code"></pre>
    </section>
  </main>

  <footer class="wrap">
    <p class="mono">API_BASE: <code id="apiShown"></code> / Origin: <code id="originShown"></code></p>
  </footer>

  <script>
    const API_BASE = "https://neon-api-3a0h.onrender.com";
    const $ = (id)=>document.getElementById(id);
    const KEY_READ="READ_TOKEN", KEY_WRITE="WRITE_TOKEN";
    $("apiShown").textContent=API_BASE; $("originShown").textContent=location.origin;

    function reveal3s(input, val){ if(!val)return; const t=input.type; input.type="text"; input.value=val; setTimeout(()=>{input.type=t;input.value="********";},3000);}
    $("showRead").onclick=()=>reveal3s($("readToken"), sessionStorage.getItem(KEY_READ)||"");
    $("showWrite").onclick=()=>reveal3s($("writeToken"), sessionStorage.getItem(KEY_WRITE)||"");

    $("saveTokens").onclick=()=>{
      const r=$("readToken").value.trim(), w=$("writeToken").value.trim();
      if(r)sessionStorage.setItem(KEY_READ,r); if(w)sessionStorage.setItem(KEY_WRITE,w);
      alert("ä¿å­˜ã—ã¾ã—ãŸ"); $("readToken").value="********"; $("writeToken").value="********";
    };
    $("clearTokens").onclick=()=>{sessionStorage.clear(); $("readToken").value=""; $("writeToken").value=""; alert("å‰Šé™¤ã—ã¾ã—ãŸ");};

    async function jreq(path,method="GET",token="",body=null){
      const res=await fetch(API_BASE+path,{method,headers:{"Content-Type":"application/json",...(token?{"Authorization":"Bearer "+token}:{})},body:body?JSON.stringify(body):undefined});
      const txt=await res.text(); try{return{ok:res.ok,data:JSON.parse(txt)}}catch{return{ok:res.ok,data:txt}}
    }

    $("btnHealth").onclick=async()=>{
      $("healthStatus").textContent="loading..."; const r=await jreq("/health");
      $("healthStatus").textContent=r.ok?"OK":"ERR"; $("healthRaw").textContent=JSON.stringify(r.data,null,2);
    };

    // ä¸€è¦§èª­è¾¼ï¼šinclude_deleted=true ã‚’æ­£ã—ãä»˜ã‘ã‚‹
    $("btnLoad").onclick=async()=>{
      $("loadStatus").textContent="loading...";
      const read=sessionStorage.getItem(KEY_READ)||"";
      const write=sessionStorage.getItem(KEY_WRITE)||"";
      const token= read || write; // ã©ã¡ã‚‰ã‹ã‚ã‚Œã°OKï¼ˆadminãªã‚‰å‰Šé™¤æ¸ˆã¿ã‚‚è¦‹ãˆã‚‹ï¼‰
      const includeDel = $("showDeleted").checked ? "&include_deleted=true" : "";
      const r=await jreq(`/notes?order_by=updated_at&order=desc${includeDel}`,"GET",token);
      const body=$("notesTable").querySelector("tbody"); body.innerHTML="";
      if(!r.ok){$("loadStatus").textContent="ERR";return;}
      const rows=Array.isArray(r.data)?r.data:(r.data.results||[]);
      rows.forEach(it=>{
        const tr=document.createElement("tr");
        const isDeleted = it.deleted_at !== null && it.deleted_at !== undefined;
        if(isDeleted) tr.className="deleted-row";
        const tags = Array.isArray(it.tags) ? it.tags.join(",") : (it.tags ?? "");
        tr.innerHTML=`
          <td>${it.id}</td>
          <td>${it.content ?? ""}</td>
          <td>${tags}</td>
          <td>${it.created_at ?? ""}</td>
          <td>${it.updated_at ?? ""}</td>
          <td>${it.deleted_at ?? ""}</td>
          <td>${
            isDeleted
              ? `<button data-id="${it.id}" class="restore">å¾©å…ƒ</button>`
              : `<button data-id="${it.id}" class="danger delete">å‰Šé™¤</button>`
          }</td>`;
        body.appendChild(tr);
      });
      $("loadStatus").textContent=`${rows.length}ä»¶`;
      document.querySelectorAll(".delete").forEach(btn=>btn.onclick=()=>act(btn.dataset.id,"DELETE"));
      document.querySelectorAll(".restore").forEach(btn=>btn.onclick=()=>act(btn.dataset.id,"RESTORE"));
    };

    // DELETE / POST /notes/:id/restore
    async function act(id,mode){
      const token=sessionStorage.getItem(KEY_WRITE)||"";
      if(!token)return alert("ãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šï¼ˆWRITE/ADMINï¼‰");
      if(mode==="DELETE") await jreq(`/notes/${id}`,"DELETE",token);
      if(mode==="RESTORE") await jreq(`/notes/${id}/restore`,"POST",token);
      $("btnLoad").click();
    }

    $("btnPost").onclick=async()=>{
      const token=sessionStorage.getItem(KEY_WRITE)||""; if(!token)return alert("æœªè¨­å®š");
      const content=$("content").value.trim();
      const tags=$("tags").value.split(",").map(s=>s.trim()).filter(Boolean);
      if(!content){alert("content ã¯å¿…é ˆã§ã™"); return;}
      if(tags.length===0){alert("tags ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„"); return;}
      const r=await jreq("/notes","POST",token,{content,tags});
      $("postRaw").textContent=JSON.stringify(r.data,null,2);
      $("btnLoad").click();
    };
  </script>
</body>
</html>
