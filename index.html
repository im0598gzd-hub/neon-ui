<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minimal Web UI (vA6) â€” READ/WRITE</title>
  <style>
    :root{--bg:#0d1117;--fg:#e6edf3;--muted:#8b949e;--line:#30363d;--card:#161b22;--blue:#58a6ff;--green:#2ea043;--red:#f85149}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:0 0 6px;color:#79c0ff}
    .sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,textarea{width:100%;background:#0f1420;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:10px 12px}
    textarea{resize:vertical}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button{background:#0f1420;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--green);border-color:var(--green);color:#fff}
    button.danger{border-color:var(--red);color:var(--red)}
    button.ghost{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
    .code{background:#0b1020;border:1px solid var(--line);border-radius:10px;padding:12px;overflow:auto;max-height:260px}
    .pwline{display:flex;gap:6px}
    .right{margin-left:auto}
    /* å‰Šé™¤æ¸ˆã¿è¡Œã®è¦‹ãŸç›® */
    tr.deleted{opacity:.55}
    tr.deleted td.content{text-decoration:line-through}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:1px 8px;font-size:12px;color:var(--muted)}
    .badge.del{border-color:var(--red);color:var(--red)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Minimal Web UI (vA6)</h1>
    <p class="sub">ã€ŒäººãŒè§¦ã‚Œã¦ã‚‚å£Šã‚Œãªã„æœ€å°ã®çª“ã€â€” GitHub Pagesï¼ˆUIï¼‰ Ã— Renderï¼ˆAPIï¼‰</p>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šéµãƒ»ãƒ˜ãƒ«ã‚¹ -->
    <section class="card">
      <h2>ğŸ” éµï¼ˆBearerï¼‰</h2>
      <p class="mono">â€» éµã¯ <code>sessionStorage</code> ã®ã¿ï¼ˆä¸€æ™‚ä¿å­˜ï¼‰ã€‚<br>â€» ç”»é¢å…±æœ‰ãƒ»éŒ²ç”»æ™‚ã«éµã‚’<strong>è¡¨ç¤ºã—ãªã„</strong>ã§ãã ã•ã„ã€‚</p>

      <label for="readToken">READ ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="readToken" type="password" placeholder="READ ç”¨ã® Bearer å€¤" autocomplete="off">
        <button id="showRead" class="ghost" type="button">è¡¨ç¤º(3s)</button>
      </div>

      <label for="adminToken" style="margin-top:6px">WRITE/ADMIN ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="adminToken" type="password" placeholder="ADMIN ç”¨ Bearer å€¤ï¼ˆå‰Šé™¤ãƒ»å¾©å…ƒãƒ»æŠ•ç¨¿ï¼‰" autocomplete="off">
        <button id="showAdmin" class="ghost" type="button">è¡¨ç¤º(3s)</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="saveTokens" class="primary" type="button">éµã‚’ä¿å­˜ï¼ˆã“ã®ã‚¿ãƒ–å†…ï¼‰</button>
        <button id="clearTokens" class="danger" type="button">éµã‚’ã™ã¹ã¦æ¶ˆå»</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h2>ğŸ©º /health</h2>
      <div class="row">
        <button id="btnHealth" type="button">/health ã‚’ç¢ºèª</button>
        <span id="healthStatus" class="mono"></span>
      </div>
      <pre id="healthRaw" class="code"></pre>
    </section>

    <!-- å³ï¼šnotes ä¸€è¦§ + æŠ•ç¨¿ -->
    <section class="card">
      <h2>ğŸ—’ï¸ /notesï¼ˆä¸€è¦§ï¼‰</h2>
      <div class="row">
        <button id="btnLoad" type="button">ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€ï¼ˆREADï¼‰</button>
        <label class="row" style="gap:6px">
          <input id="chkDeleted" type="checkbox">
          <span>å‰Šé™¤æ¸ˆã¿ã‚‚è¡¨ç¤ºï¼ˆ<span class="mono">ADMIN å¿…é ˆ</span>ï¼‰</span>
        </label>
        <span id="loadStatus" class="mono right"></span>
      </div>
      <table class="table" id="notesTable">
        <thead>
          <tr>
            <th style="width:64px">ID</th>
            <th>Content</th>
            <th style="width:18%">Tags</th>
            <th style="width:19%">Created</th>
            <th style="width:19%">Updated</th>
            <th style="width:90px">Deleted</th>
            <th style="width:110px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h2>âœï¸ /notesï¼ˆæ–°è¦æŠ•ç¨¿ï¼‰</h2>
      <label for="content">content</label>
      <textarea id="content" rows="4" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
      <label for="tags">tagsï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
      <input id="tags" type="text" placeholder="ä¾‹: project,idea">

      <div class="row" style="margin-top:8px">
        <button id="btnPost" class="primary" type="button">æŠ•ç¨¿ã™ã‚‹ï¼ˆADMINï¼‰</button>
        <span id="postStatus" class="mono"></span>
      </div>
      <pre id="postRaw" class="code"></pre>
    </section>
  </main>

  <footer class="wrap">
    <p class="mono">API_BASE: <code id="apiShown"></code> / Origin: <code id="originShown"></code></p>
  </footer>

  <script>
    // ===== APIãƒ™ãƒ¼ã‚¹URLè‡ªå‹•æ±ºå®š =====
    (function decideApiBase(){
      const u = new URL(location.href);
      const q = u.searchParams.get("api");
      window.API_BASE = q && q.trim() ? q.trim() : "https://neon-api-3a0h.onrender.com";
    })();

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);
    $("apiShown").textContent = window.API_BASE;
    $("originShown").textContent = location.origin;

    const readInput  = $("readToken");
    const adminInput = $("adminToken");
    const chkDeleted = $("chkDeleted");

    const healthStatus = $("healthStatus");
    const healthRaw = $("healthRaw");
    const loadStatus = $("loadStatus");
    const notesBody = document.querySelector("#notesTable tbody");
    const postStatus = $("postStatus");
    const postRaw = $("postRaw");

    // ===== sessionStorage keys =====
    const KEY_READ  = "READ_TOKEN";
    const KEY_ADMIN = "ADMIN_TOKEN";

    // åˆæœŸå¾©å…ƒï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    try {
      if (sessionStorage.getItem(KEY_READ))  readInput.value  = "********";
      if (sessionStorage.getItem(KEY_ADMIN)) adminInput.value = "********";
    } catch {}

    // 3ç§’ã ã‘è¡¨ç¤º
    function reveal3s(input, getter) {
      const val = getter();
      if (!val) return;
      const t = input.type;
      const prev = input.value;
      input.type = "text";
      input.value = val;
      setTimeout(() => { input.type = t; input.value = "********"; }, 3000);
    }
    $("showRead").onclick  = () => reveal3s(readInput,  () => sessionStorage.getItem(KEY_READ)  || "");
    $("showAdmin").onclick = () => reveal3s(adminInput, () => sessionStorage.getItem(KEY_ADMIN) || "");

    // ä¿å­˜ï¼æ¶ˆå»
    $("saveTokens").onclick = () => {
      const r = readInput.value.includes("*")  ? (sessionStorage.getItem(KEY_READ)  || "") : readInput.value.trim();
      const a = adminInput.value.includes("*") ? (sessionStorage.getItem(KEY_ADMIN) || "") : adminInput.value.trim();
      if (r) sessionStorage.setItem(KEY_READ, r);
      if (a) sessionStorage.setItem(KEY_ADMIN, a);
      alert("éµã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ã‚¿ãƒ–å†…ï¼‰");
      if (r) readInput.value = "********";
      if (a) adminInput.value = "********";
    };
    $("clearTokens").onclick = () => {
      try { sessionStorage.removeItem(KEY_READ); sessionStorage.removeItem(KEY_ADMIN); } catch {}
      readInput.value = ""; adminInput.value = "";
      alert("éµã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã—ãŸã€‚");
    };

    // ===== fetch ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    async function jreq(path, method="GET", token="", body=null) {
      const url = API_BASE + path;
      const headers = {"Content-Type":"application/json"};
      if (token) headers["Authorization"] = "Bearer " + token;
      try {
        const res = await fetch(url, {method, headers, body: body?JSON.stringify(body):undefined});
        const txt = await res.text();
        let data; try { data = txt ? JSON.parse(txt) : null } catch { data = txt }
        return {ok: res.ok, status: res.status, headers: res.headers, data};
      } catch (e) {
        return {ok:false, status:0, headers:new Headers(), data:{error:String(e)}};
      }
    }

    // ===== /health =====
    $("btnHealth").onclick = async () => {
      healthStatus.textContent = "loading...";
      healthRaw.textContent = "";
      const r = await jreq("/health");
      healthStatus.textContent = r.ok ? "OK" : `ERR(${r.status})`;
      healthRaw.textContent = typeof r.data === "string" ? r.data : JSON.stringify(r.data, null, 2);
    };

    // ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆ1è¡Œï¼‰ =====
    function renderRow(it){
      // æ—¢å­˜è¡ŒãŒã‚ã‚Œã°ç½®æ›
      let tr = notesBody.querySelector(`tr[data-id="${it.id}"]`);
      const isNew = !tr;
      if (isNew) tr = document.createElement("tr");
      tr.dataset.id = it.id;

      tr.classList.toggle("deleted", !!it.deleted_at);

      tr.innerHTML = "";
      const td = (text, cls) => {
        const d=document.createElement("td");
        if (cls) d.className = cls;
        d.textContent=(text??"");
        return d;
      };

      tr.appendChild(td(it.id));
      const tdContent = td(it.content, "content");
      tr.appendChild(tdContent);
      tr.appendChild(td(Array.isArray(it.tags)?it.tags.join(","):""));
      tr.appendChild(td(it.created_at));
      tr.appendChild(td(it.updated_at));

      // Deletedåˆ—
      const tdDel = document.createElement("td");
      if (it.deleted_at) {
        const b = document.createElement("span");
        b.className = "badge del";
        b.textContent = "deleted";
        tdDel.appendChild(b);
      } else {
        tdDel.textContent = "â€”";
      }
      tr.appendChild(tdDel);

      // Actionsåˆ—
      const tdAct = document.createElement("td");
      const btn = document.createElement("button");
      btn.type = "button";
      if (it.deleted_at) {
        btn.textContent = "å¾©å…ƒ";
        btn.className = "primary";
        btn.onclick = async () => {
          const admin = sessionStorage.getItem(KEY_ADMIN) || "";
          if (!admin){ alert("ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"); return; }
          btn.disabled = true;
          const r = await jreq(`/notes/${it.id}/restore`, "POST", admin);
          btn.disabled = false;
          if (!r.ok){ alert(`å¾©å…ƒå¤±æ•— (${r.status})`); return; }
          // è¡Œã‚’æ®‹ã—ãŸã¾ã¾é€šå¸¸è¡¨ç¤ºã¸æ›´æ–°
          const updated = r.data;
          it.deleted_at = updated.deleted_at; // null
          it.updated_at = updated.updated_at;
          renderRow(it);
        };
      } else {
        btn.textContent = "å‰Šé™¤";
        btn.className = "danger";
        btn.onclick = async () => {
          const admin = sessionStorage.getItem(KEY_ADMIN) || "";
          if (!admin){ alert("ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"); return; }
          if (!confirm(`ID ${it.id} ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆï¼‰ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
          btn.disabled = true;
          const r = await jreq(`/notes/${it.id}`, "DELETE", admin);
          btn.disabled = false;
          if (!r.ok){ alert(`å‰Šé™¤å¤±æ•— (${r.status})`); return; }
          // ç›´ã¡ã«å‰Šé™¤æ¸ˆã¿è¡¨ç¤ºã¸ï¼ˆä¿æŒï¼‰
          it.deleted_at = new Date().toISOString();
          renderRow(it);
          // ã€Œå‰Šé™¤æ¸ˆã¿ã‚’è¡¨ç¤ºã€ãŒOFFãªã‚‰ã€ç¾åœ¨ã®ä¸€è¦§ã‹ã‚‰ã¯é™¤å»
          if (!chkDeleted.checked){
            tr.remove();
          }
        };
      }
      tdAct.appendChild(btn);
      tr.appendChild(tdAct);

      if (isNew) notesBody.appendChild(tr);
    }

    // ===== ä¸€è¦§ãƒ­ãƒ¼ãƒ‰ =====
    $("btnLoad").onclick = async () => {
      loadStatus.textContent = "loading...";
      notesBody.innerHTML = "";
      const read = sessionStorage.getItem(KEY_READ) || "";
      if (!read) { loadStatus.textContent = "READãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"; return; }

      const params = new URLSearchParams();
      if (chkDeleted.checked){
        // å‰Šé™¤æ¸ˆã¿ã‚‚è¡¨ç¤ºï¼ˆADMINã‚­ãƒ¼ã§ include_deleted=trueï¼‰
        const admin = sessionStorage.getItem(KEY_ADMIN) || "";
        if (!admin){ loadStatus.textContent = "ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"; return; }
        params.set("include_deleted","true");
        var tokenForList = admin; // èª­ã¿è¾¼ã¿ã¯ADMINã§
      } else {
        var tokenForList = read;  // é€šå¸¸ã¯READã§
      }

      const r = await jreq(`/notes?${params.toString()}`, "GET", tokenForList);
      if (!r.ok) { loadStatus.textContent = `ERR(${r.status})`; return; }

      const rows = Array.isArray(r.data) ? r.data : (r.data?.results || []);
      if (!rows || rows.length === 0) { loadStatus.textContent = "0ä»¶"; return; }
      for (const it of rows) renderRow(it);
      loadStatus.textContent = `${rows.length}ä»¶`;
    };

    // ===== æ–°è¦æŠ•ç¨¿ =====
    $("btnPost").onclick = async () => {
      postStatus.textContent = "posting...";
      postRaw.textContent = "";
      const admin = sessionStorage.getItem(KEY_ADMIN) || "";
      if (!admin) { postStatus.textContent = "ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"; return; }
      const content = $("content").value.trim();
      const tags = ($("tags").value.trim() || "").split(",").map(s=>s.trim()).filter(Boolean);
      const r = await jreq("/notes", "POST", admin, {content, tags});
      postStatus.textContent = r.ok ? "OK" : `ERR(${r.status})`;
      postRaw.textContent = typeof r.data === "string" ? r.data : JSON.stringify(r.data, null, 2);
      if (r.ok) {
        const it = r.data;
        renderRow(it); // ãã®ã¾ã¾è¿½åŠ 
        $("content").value = ""; $("tags").value = "";
      }
    };

    // å®‰å…¨ï¼šéµã¯consoleã‚„URLã«å‡ºã•ãªã„
  </script>
</body>
</html>
