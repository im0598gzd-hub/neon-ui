<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minimal Web UI (vA6) â€” READ / WRITE(ADMIN)</title>
  <style>
    :root{--bg:#0d1117;--fg:#e6edf3;--muted:#8b949e;--line:#30363d;--card:#161b22;--blue:#58a6ff;--green:#2ea043;--red:#f85149;--amber:#d29922}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:0 0 6px;color:#79c0ff}
    .sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,textarea{width:100%;background:#0f1420;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:10px 12px}
    textarea{resize:vertical}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button{background:#0f1420;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--green);border-color:var(--green);color:#fff}
    button.danger{border-color:var(--red);color:var(--red)}
    button.ghost{color:var(--muted)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
    .code{background:#0b1020;border:1px solid var(--line);border-radius:10px;padding:12px;overflow:auto;max-height:260px}
    .pwline{display:flex;gap:6px}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:#fff}
    .badge.del{background:rgba(248,81,73,.15);border-color:var(--red);color:#ffaba8}
    .muted{color:var(--muted)}
    .strike{opacity:.8;text-decoration:line-through}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Minimal Web UI (vA6)</h1>
    <p class="sub">ã€ŒäººãŒè§¦ã‚Œã¦ã‚‚å£Šã‚Œãªã„æœ€å°ã®çª“ã€â€” GitHub Pagesï¼ˆUIï¼‰ Ã— Renderï¼ˆAPIï¼‰</p>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šéµãƒ»ãƒ˜ãƒ«ã‚¹ -->
    <section class="card">
      <h2>ğŸ” éµï¼ˆBearerï¼‰</h2>
      <p class="mono">â€» éµã¯ <code>sessionStorage</code> ã®ã¿ï¼ˆä¸€æ™‚ä¿å­˜ï¼‰ã€‚<br>â€» ç”»é¢å…±æœ‰ãƒ»éŒ²ç”»æ™‚ã«éµã‚’<strong>è¡¨ç¤ºã—ãªã„</strong>ã§ãã ã•ã„ã€‚</p>

      <label for="readToken">READ ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="readToken" type="password" placeholder="READ ç”¨ã® Bearer å€¤" autocomplete="off">
        <button id="showRead" class="ghost" type="button">è¡¨ç¤º(3s)</button>
      </div>

      <label for="writeToken" style="margin-top:6px">WRITE/ADMIN ãƒˆãƒ¼ã‚¯ãƒ³</label>
      <div class="pwline">
        <input id="writeToken" type="password" placeholder="ADMINï¼ˆå‰Šé™¤ãƒ»å¾©å…ƒãƒ»æŠ•ç¨¿ï¼‰ç”¨ Bearer å€¤" autocomplete="off">
        <button id="showWrite" class="ghost" type="button">è¡¨ç¤º(3s)</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="saveTokens" class="primary" type="button">éµã‚’ä¿å­˜ï¼ˆã“ã®ã‚¿ãƒ–å†…ï¼‰</button>
        <button id="clearTokens" class="danger" type="button">éµã‚’ã™ã¹ã¦æ¶ˆå»</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h2>ğŸ©º /health</h2>
      <div class="row">
        <button id="btnHealth" type="button">/health ã‚’ç¢ºèª</button>
        <span id="healthStatus" class="mono"></span>
      </div>
      <pre id="healthRaw" class="code"></pre>
    </section>

    <!-- å³ï¼šnotes ä¸€è¦§ + æŠ•ç¨¿ -->
    <section class="card">
      <h2>ğŸ—’ï¸ /notesï¼ˆä¸€è¦§ï¼‰</h2>

      <div class="row">
        <button id="btnLoad" type="button">ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€</button>
        <label class="row" style="gap:6px;margin:0 0 0 8px">
          <input id="chkIncludeDeleted" type="checkbox">
          <span class="mono">å‰Šé™¤æ¸ˆã¿ã‚‚è¡¨ç¤ºï¼ˆADMIN å¿…é ˆï¼‰</span>
        </label>
        <span id="loadStatus" class="mono"></span>
      </div>

      <table class="table" id="notesTable">
        <thead>
          <tr>
            <th>ID</th><th>Content</th><th>Tags</th><th>Created</th><th>Updated</th><th>Deleted</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <h2>âœï¸ /notesï¼ˆæ–°è¦æŠ•ç¨¿ï¼‰</h2>
      <label for="content">content</label>
      <textarea id="content" rows="4" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
      <label for="tags">tagsï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
      <input id="tags" type="text" placeholder="ä¾‹: project,idea">

      <div class="row" style="margin-top:8px">
        <button id="btnPost" class="primary" type="button">æŠ•ç¨¿ã™ã‚‹ï¼ˆADMINï¼‰</button>
        <span id="postStatus" class="mono"></span>
      </div>
      <pre id="postRaw" class="code"></pre>
    </section>
  </main>

  <footer class="wrap">
    <p class="mono">API_BASE: <code id="apiShown"></code> / Origin: <code id="originShown"></code></p>
  </footer>

  <script>
    // === å›ºå®šï¼šRender API ãƒ™ãƒ¼ã‚¹ ===
    const API_BASE = "https://neon-api-3a0h.onrender.com";

    // === DOM ===
    const $ = (id) => document.getElementById(id);
    const readInput = $("readToken");
    const writeInput = $("writeToken");
    const healthStatus = $("healthStatus");
    const healthRaw = $("healthRaw");
    const loadStatus = $("loadStatus");
    const notesBody = document.querySelector("#notesTable tbody");
    const postStatus = $("postStatus");
    const postRaw = $("postRaw");
    const chkIncludeDeleted = $("chkIncludeDeleted");

    $("apiShown").textContent = API_BASE;
    $("originShown").textContent = location.origin;

    // === sessionStorage keys ===
    const KEY_READ = "READ_TOKEN";
    const KEY_WRITE = "WRITE_TOKEN";

    // åˆæœŸå¾©å…ƒï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    try {
      if (sessionStorage.getItem(KEY_READ)) readInput.value = "********";
      if (sessionStorage.getItem(KEY_WRITE)) writeInput.value = "********";
    } catch {}

    // 3ç§’ã ã‘è¡¨ç¤º
    function reveal3s(input, getter) {
      const val = getter();
      if (!val) return;
      const t = input.type;
      const prev = input.value;
      input.type = "text";
      input.value = val;
      setTimeout(() => { input.type = t; input.value = "********"; }, 3000);
    }
    $("showRead").onclick = () => reveal3s(readInput, () => sessionStorage.getItem(KEY_READ) || "");
    $("showWrite").onclick = () => reveal3s(writeInput, () => sessionStorage.getItem(KEY_WRITE) || "");

    // ä¿å­˜
    $("saveTokens").onclick = () => {
      const r = readInput.value.includes("*") ? (sessionStorage.getItem(KEY_READ) || "") : readInput.value.trim();
      const w = writeInput.value.includes("*") ? (sessionStorage.getItem(KEY_WRITE) || "") : writeInput.value.trim();
      if (r) sessionStorage.setItem(KEY_READ, r);
      if (w) sessionStorage.setItem(KEY_WRITE, w);
      alert("éµã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ã‚¿ãƒ–å†…ï¼‰");
      if (r) readInput.value = "********";
      if (w) writeInput.value = "********";
    };

    // ã™ã¹ã¦æ¶ˆå»
    $("clearTokens").onclick = () => {
      try { sessionStorage.clear(); } catch {}
      readInput.value = ""; writeInput.value = "";
      alert("éµã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã—ãŸã€‚");
    };

    // fetch ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚­ãƒ¼ã¯æ¸¡ã•ã‚ŒãŸã¨ãã®ã¿ä»˜ä¸ï¼‰
    async function jreq(path, method="GET", token="", body=null) {
      const url = API_BASE + path;
      const headers = {"Content-Type":"application/json"};
      if (token) headers["Authorization"] = "Bearer " + token;
      try {
        const res = await fetch(url, {method, headers, body: body?JSON.stringify(body):undefined});
        const txt = await res.text();
        let data; try { data = txt ? JSON.parse(txt) : null } catch { data = txt }
        return {ok: res.ok, status: res.status, headers: res.headers, data};
      } catch (e) {
        return {ok:false, status:0, headers:new Headers(), data:{error:String(e)}};
      }
    }

    // /health
    $("btnHealth").onclick = async () => {
      healthStatus.textContent = "loading...";
      healthRaw.textContent = "";
      const r = await jreq("/health");
      healthStatus.textContent = r.ok ? "OK" : `ERR(${r.status})`;
      healthRaw.textContent = typeof r.data === "string" ? r.data : JSON.stringify(r.data, null, 2);
    };

    // è¡Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderRow(it, hasAdmin) {
      const tr = document.createElement("tr");
      const td = (html)=>{const d=document.createElement("td"); d.innerHTML=(html??""); return d};

      const contentHtml = it.deleted_at ? `<span class="strike">${escapeHtml(it.content||"")}</span>` : escapeHtml(it.content||"");
      const tagsHtml = Array.isArray(it.tags)? escapeHtml(it.tags.join(",")) : "";

      tr.dataset.id = it.id;
      tr.appendChild(td(String(it.id)));
      tr.appendChild(td(contentHtml));
      tr.appendChild(td(tagsHtml));
      tr.appendChild(td(escapeHtml(it.created_at||"")));
      tr.appendChild(td(escapeHtml(it.updated_at||"")));
      tr.appendChild(td(it.deleted_at ? `<span class="badge del">deleted</span><br><span class="muted">${escapeHtml(it.deleted_at)}</span>` : "â€”"));

      if (hasAdmin) {
        const btns = document.createElement("td");
        if (it.deleted_at) {
          btns.innerHTML = `<button class="btn-restore">å¾©å…ƒ</button>`;
        } else {
          btns.innerHTML = `<button class="btn-delete danger">å‰Šé™¤</button>`;
        }
        tr.appendChild(btns);
      } else {
        tr.appendChild(td(`<span class="muted">â€”</span>`));
      }
      return tr;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // /notes ä¸€è¦§
    $("btnLoad").onclick = loadNotes;
    async function loadNotes() {
      loadStatus.textContent = "loading...";
      notesBody.innerHTML = "";

      const wantDeleted = chkIncludeDeleted.checked;
      const hasAdminToken = !!(sessionStorage.getItem(KEY_WRITE) || "");
      const readToken = sessionStorage.getItem(KEY_READ) || "";
      const adminToken = sessionStorage.getItem(KEY_WRITE) || "";

      // include_deleted ã¯ã‚µãƒ¼ãƒå´ã§ã€ŒADMIN ã®ã¿è¨±å¯ã€ã€‚ONæ™‚ã¯ADMINãƒˆãƒ¼ã‚¯ãƒ³ã§èª­ã¿è¾¼ã‚€ã€‚
      const useToken = wantDeleted ? adminToken : readToken;
      if (!useToken) {
        loadStatus.textContent = wantDeleted ? "ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š" : "READãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š";
        return;
      }

      const qs = wantDeleted ? "?include_deleted=true" : "";
      const r = await jreq("/notes"+qs, "GET", useToken);
      if (!r.ok) { loadStatus.textContent = `ERR(${r.status})`; return; }

      const rows = Array.isArray(r.data) ? r.data : (r.data?.results || []);
      if (!rows || rows.length === 0) { loadStatus.textContent = "0ä»¶"; return; }

      for (const it of rows) notesBody.appendChild(renderRow(it, hasAdminToken));
      loadStatus.textContent = `${rows.length}ä»¶`;
    }

    // Delegation: å‰Šé™¤ï¼å¾©å…ƒ
    notesBody.addEventListener("click", async (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      const tr = t.closest("tr");
      if (!tr) return;
      const id = Number(tr.dataset.id || "0");
      if (!id) return;

      const admin = sessionStorage.getItem(KEY_WRITE) || "";
      if (!admin) { alert("ADMINãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªè¨­å®šã§ã™ã€‚"); return; }

      if (t.classList.contains("btn-delete")) {
        if (!confirm(`ID ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
        t.setAttribute("disabled","true");
        const r = await jreq(`/notes/${id}`, "DELETE", admin);
        t.removeAttribute("disabled");
        if (!r.ok) { alert(`å‰Šé™¤ã«å¤±æ•—: ${r.status}`); return; }
        // æ¥½è¦³æ›´æ–°ï¼šDeletedåˆ—ã¨ãƒœã‚¿ãƒ³ã‚’å·®ã—æ›¿ãˆ
        tr.querySelectorAll("td")[5].innerHTML = `<span class="badge del">deleted</span><br><span class="muted">${new Date().toISOString()}</span>`;
        tr.querySelectorAll("td")[1].innerHTML = `<span class="strike">${tr.querySelectorAll("td")[1].textContent}</span>`;
        tr.querySelectorAll("td")[6].innerHTML = `<button class="btn-restore">å¾©å…ƒ</button>`;
      }

      if (t.classList.contains("btn-restore")) {
        t.setAttribute("disabled","true");
        const r = await jreq(`/notes/${id}/restore`, "POST", admin);
        t.removeAttribute("disabled");
        if (!r.ok) { alert(`å¾©å…ƒã«å¤±æ•—: ${r.status}`); return; }
        // è¿”ã£ã¦ããŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§è¡Œã‚’æç”»ã—ç›´ã™
        const it = r.data || {};
        const hasAdminToken = true;
        const newTr = renderRow(it, hasAdminToken);
        tr.replaceWith(newTr);
      }
    });

    // /notes æŠ•ç¨¿ï¼ˆADMINï¼‰
    $("btnPost").onclick = async () => {
      postStatus.textContent = "posting...";
      postRaw.textContent = "";
      const token = sessionStorage.getItem(KEY_WRITE) || "";
      if (!token) { postStatus.textContent = "ADMINãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®š"; return; }
      const content = $("content").value.trim();
      const tags = ($("tags").value.trim() || "")
        .split(",").map(s=>s.trim()).filter(Boolean);
      const r = await jreq("/notes", "POST", token, {content, tags});
      postStatus.textContent = r.ok ? "OK" : `ERR(${r.status})`;
      postRaw.textContent = typeof r.data === "string" ? r.data : JSON.stringify(r.data, null, 2);
      if (r.ok) $("btnLoad").click(); // æˆåŠŸã—ãŸã‚‰ä¸€è¦§ã‚’æ›´æ–°
    };

    // é‡è¦ï¼šéµã‚’ console.log ã‚„ URL ã«å‡ºã•ãªã„ï¼ˆä½•ã‚‚å‡ºåŠ›ã—ãªã„ï¼‰
  </script>
</body>
</html>
